define(["jquery"],function(a){var b=3e3,c=0,d=3e3,e=0;return{setOptions:function(a,b,c,d){a=a,b=b,c=c,d=d},initCodeRecording:function(d,e,f,g){var h,i,j=!1,k=new Array,l=a.now(),m=function(){return void 0!=window.vpl_files&&null!=window.vpl_files&&window.vpl_files.length>0},n=function(){if(!m())return void(h=setTimeout(n,b));for(var c=new Array,d=0;d<window.vpl_files.length;d++)c.push({fileName:window.vpl_files[d].getFileName(),content:window.vpl_files[d].getContent()});k.push({startTime:l,elapsedTime:a.now()-l,files:c}),h=setTimeout(n,b)},o=function(){return m()?(q(function(){p(function(){k=new Array,r()})}),void(i=setTimeout(o,c))):void(i=setTimeout(o,c))},p=function(b){k.length>0&&a.ajax({url:e,data:{cmid:f,userid:g,action:"savecoderecording",codeData:k},method:"POST"}).done(function(){k=new Array,b()}).fail(function(){console.log("ERROR: Can't send data "+k+" to "+e)})},q=function(a){j=!1,clearTimeout(h),c>0&&clearTimeout(i),void 0!=a&&null!=a&&a()},r=function(){j||(n(),c>0&&o()),j=!0};a(window).blur(function(){q(function(){p(function(){})})}),a(window).unload(function(){q(function(){p(function(){})})}),a(window).load(function(){r()}),a(window).focus(function(){r()})},initScreenRecording:function(b,c,f,g){var h,i,j,k,l,m,n=!1,o=function(){return void 0!=k&&null!=k&&void 0!=l&&null!=l&&void 0!=m&&null!=m},p=function(b){o()&&k.stopRecording(function(){var d=k.getBlob(),e=new FormData;e.append("video-filename","video.webm"),e.append("video-blob",d),e.append("action","savescreenrecording"),e.append("cmid",f),e.append("userid",g),a.ajax({url:c,data:e,processData:!1,contentType:!1,method:"POST"}).done(b)})},q=function(){return o()?(s(function(){p(function(){t()})}),void(i=setTimeout(q,e))):void(i=setTimeout(q,e))},r=function(){return o()?void html2canvas(j,{grabMouse:!1,onrendered:function(a){m.clearRect(0,0,l.width,l.height),m.drawImage(a,0,0,l.width,l.height),h=setTimeout(r,d)}}):void(h=setTimeout(r,d))},s=function(a){n=!1,clearTimeout(h),e>0&&clearTimeout(i),void 0!=a&&null!=a&&a()},t=function(){n||(void 0!=j&&null!=j||(j=document.getElementById(b)),void 0!=l&&null!=l||(l=document.createElement("canvas"),l.width=j.clientWidth,l.height=j.clientHeight,l.style.top=0,l.style.left=0,l.style.zIndex=-1,(document.body||document.documentElement).appendChild(l),l.style.visibility="hidden"),m=l.getContext("2d"),k=new RecordRTC(l,{type:"canvas"}),k.startRecording(),r(),e>0&&q()),n=!0};a(window).blur(function(){s(function(){p(function(){})})}),a(window).unload(function(){s(function(){p(function(){})})}),a(window).load(function(){t()}),a(window).focus(function(){t()})}}});